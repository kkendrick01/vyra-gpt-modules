<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Client Brand Voice Playbook™ Anaylzer | Vyralab</title>
<style>
  :root{
    --vyra-black:#0A0A0A;
    --vyra-green:#00FF41;
    --vyra-white:#F2F2F2;
    --vyra-steel:#2A2A2A;
    --vyra-steel-2:#3A3A3A;
    --glow:0 0 22px rgba(0,255,65,.35);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Inter','Segoe UI',Roboto,Arial,sans-serif;background:var(--vyra-black);color:var(--vyra-white);line-height:1.6;overflow-x:hidden}
  .bg-grid{position:fixed;inset:0;background-image:
    linear-gradient(rgba(0,255,65,.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,255,65,.03) 1px,transparent 1px);
    background-size:50px 50px;z-index:0;animation:gridMove 26s linear infinite}
  @keyframes gridMove{0%{transform:translate(0,0)}100%{transform:translate(50px,50px)}}

  .progress{position:fixed;top:0;left:0;height:3px;width:100%;background:var(--vyra-steel);z-index:999}
  .progress > div{height:100%;width:0;background:linear-gradient(90deg,var(--vyra-green),#00FF95);box-shadow:var(--glow);transition:width .2s ease}

  .hero{min-height:88vh;display:flex;align-items:center;justify-content:center;padding:2rem;position:relative;z-index:1;background:radial-gradient(circle at 50% 40%,rgba(0,255,65,.08),transparent 60%)}
  .hero-in{max-width:1024px;text-align:center;animation:fadeInUp .8s ease}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
  .badge{display:inline-flex;border:1px solid var(--vyra-green);color:var(--vyra-green);padding:.45rem .9rem;border-radius:999px;gap:.5rem;align-items:center;margin-bottom:.9rem;box-shadow:var(--glow);text-transform:uppercase;font-size:.8rem;letter-spacing:.12em}
  .h1{font-size:clamp(2.2rem,5.8vw,4.4rem);font-weight:900;line-height:1.08;margin:.3rem 0 1rem;background:linear-gradient(135deg,#fff,var(--vyra-green));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
  .sub{color:#B9B9B9;max-width:820px;margin:0 auto 1.5rem}
  .cta{background:linear-gradient(135deg,var(--vyra-green),#00FFA0);color:#0a0a0a;border:none;border-radius:12px;padding:1rem 1.4rem;font-weight:800;cursor:pointer;box-shadow:var(--glow)}
  .ghost{background:transparent;border:1px solid var(--vyra-green);color:var(--vyra-green);border-radius:12px;padding:.95rem 1.25rem;font-weight:700;cursor:pointer}

  .wrap{max-width:1220px;margin:0 auto;padding:2rem 1.25rem;position:relative;z-index:1}
  .section{margin:4rem 0;opacity:0;transform:translateY(24px);transition:all .6s ease}
  .section.visible{opacity:1;transform:translateY(0)}
  .s-head{display:flex;align-items:center;gap:1rem;margin-bottom:1.2rem}
  .icon{width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,var(--vyra-green),#00FF95);display:flex;align-items:center;justify-content:center;color:#0a0a0a;font-weight:900;box-shadow:var(--glow)}
  .s-title{font-size:1.8rem;font-weight:800}

  .panel{background:var(--vyra-steel);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:1.25rem}
  .muted{opacity:.85}
  label{font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;color:#D8D8D8;margin-bottom:.35rem;display:block}
  textarea,input{width:100%;background:#101010;border:1px solid var(--vyra-steel-2);border-radius:12px;color:#f3f3f3;padding:.9rem 1rem;outline:none}
  .grid{display:grid;gap:1rem}
  @media(min-width:980px){.grid-2{grid-template-columns:1.15fr .85fr}}
  .pill{display:inline-block;background:#101010;border:1px solid #2f2f2f;border-radius:999px;padding:.25rem .7rem;margin:.18rem;font-size:.82rem}

  .meter{height:10px;background:#101010;border:1px solid #2f2f2f;border-radius:999px;overflow:hidden}
  .meter > div{height:100%;width:0;background:linear-gradient(90deg,var(--vyra-green),#00ffa0);box-shadow:var(--glow)}

  .accordion{border:1px solid var(--vyra-steel-2);border-radius:12px;overflow:hidden}
  .acc-h{background:var(--vyra-steel);padding:1.1rem 1rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .acc-h:hover{background:#333}
  .acc-c{max-height:0;overflow:hidden;background:#111;transition:max-height .3s ease,padding .3s ease}
  .acc-c.open{max-height:1400px;padding:1rem}

  .row{display:flex;gap:.75rem;flex-wrap:wrap}
  table{width:100%;border-collapse:separate;border-spacing:0;margin:.8rem 0;border-radius:12px;overflow:hidden;background:#0f0f0f}
  th{background:linear-gradient(135deg,var(--vyra-steel),var(--vyra-steel-2));color:var(--vyra-green);text-align:left;padding:.8rem 1rem;font-size:.8rem;letter-spacing:.08em;text-transform:uppercase}
  td{padding:1rem;border-top:1px solid var(--vyra-steel)}
  tr:hover td{background:rgba(0,255,65,.06)}

  .callout{background:rgba(0,255,65,.09);border-left:3px solid var(--vyra-green);padding:1rem;border-radius:12px}
  .quote{font-style:italic;color:#B9B9B9;border-left:3px solid var(--vyra-green);padding:1rem;border-radius:8px;background:#111}

  .final{background:linear-gradient(135deg,rgba(0,255,65,.12),transparent);border:1px solid rgba(0,255,65,.2);border-radius:16px;padding:2rem;text-align:center}
  .brandline{color:#9fe9b5;margin-top:1rem}
  .btn-sm{padding:.6rem .9rem;border-radius:10px;font-weight:700}
  .ok{color:#00ffa0} .warn{color:#ffd166} .bad{color:#ff5c5c}
</style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="progress"><div id="pbar"></div></div>

  <!-- HERO -->
  <section class="hero">
    <div class="hero-in">
      <div class="badge">Vyralab Masterclass</div>
      <h1 class="h1">Client Brand Voice Analyzer™</h1>
      <p class="sub">Extract the real voice. Decode the signals. Write like the founder — on command. This is your end-to-end system for voice capture, embodiment, and implementation across posts, threads, and newsletters.</p>
      <div class="row" style="justify-content:center;margin-top:.5rem">
        <button class="cta" onclick="scrollToId('extract')">Start Analyzer →</button>
      </div>
    </div>
  </section>

  <main class="wrap">
    <!-- OVERVIEW -->
    <section class="section visible" id="extract">
      <div class="s-head">
        <div class="icon">I</div>
        <div class="s-title">Overview — The 3-Phase, 8-Step System</div>
      </div>
      <div class="panel">
        <div class="grid" style="gap:.8rem">
          <div class="callout"><b>Phase 1 — Extraction:</b> Collate materials → Run Deterministic Analyzer™ → Decode signals</div>
          <div class="callout"><b>Phase 2 — Internalization:</b> Build the Voice Bible → Actor’s Method drills → Tone translation exercises</div>
          <div class="callout"><b>Phase 3 — Implementation:</b> Apply to formats → Validate in market → Iterate the Voice System</div>
        </div>
      </div>
    </section>

    <!-- PHASE 1: DETERMINISTIC ANALYZER -->
    <section class="section" id="analyzer">
      <div class="s-head">
        <div class="icon">1</div>
        <div class="s-title">Phase 1 — Extraction: Deterministic Analyzer™ (No API)</div>
      </div>
      <div class="grid grid-2">
        <!-- Left: Inputs -->
        <div class="panel">
          <label>Client / Project</label>
          <input id="clientName" placeholder="e.g., VitalPath — Dr. Reyes"/>
          <label style="margin-top:.7rem">Paste 3–10 Samples (threads, emails, transcripts)</label>
          <textarea id="samples" rows="14" placeholder="Paste ≥800 words across samples for strong signal..."></textarea>

          <div class="row" style="margin-top:.9rem">
            <button class="cta" id="analyzeBtn">Analyze Voice</button>
            <button class="ghost" id="clearBtn">Clear</button>
          </div>

          <div class="panel" style="background:#111;border-color:rgba(0,255,65,.18);margin-top:.9rem">
            <label>Optional Hints (improves accuracy)</label>
            <input id="taboos" placeholder="Taboos (comma-separated): e.g., emoji, hype, exclamation"/>
            <input id="required" style="margin-top:.5rem" placeholder="Preferred phrases: e.g., net-net, here’s the move"/>
            <p class="muted" style="margin-top:.5rem">Tip: Add long-form material to capture cadence and paragraph rhythm.</p>
          </div>
        </div>

        <!-- Right: Report -->
        <div class="panel">
          <div class="accordion">
            <div class="acc-h" onclick="accToggle(this)">
              <b>Signal Snapshot</b><span>▼</span>
            </div>
            <div class="acc-c" id="snapshot">
              <p class="muted">Run the analyzer to view tone, cadence, emotion and credibility signals.</p>
            </div>

            <div class="acc-h" onclick="accToggle(this)">
              <b>Cadence & Punctuation</b><span>▼</span>
            </div>
            <div class="acc-c">
              <div class="grid" style="grid-template-columns:1fr 1fr">
                <div>
                  <div>Avg sentence (words)</div>
                  <div class="meter"><div id="m_sent"></div></div>
                  <div style="margin:.25rem 0"><span id="avgSent">—</span> words • variability <span id="stdSent">—</span></div>
                  <div>Avg paragraph (words): <b id="avgPar">—</b></div>
                  <div>Readability (FK): <b id="fk">—</b></div>
                </div>
                <div>
                  <div>Questions: <b id="qs">—</b></div>
                  <div>Exclamations: <b id="ex">—</b></div>
                  <div>Em dashes: <b id="emd">—</b> • Ellipses: <b id="ell">—</b></div>
                  <div>Colons/Semis: <b id="cs">—</b></div>
                </div>
              </div>
            </div>

            <div class="acc-h" onclick="accToggle(this)">
              <b>Distinctive Phrases & Themes</b><span>▼</span>
            </div>
            <div class="acc-c">
              <div id="phrasesArea" class="row"></div>
              <div class="quote" style="margin-top:.6rem">
                Use distinctive phrases sparingly and strategically — like fingerprints that authenticate the voice.
              </div>
            </div>

            <div class="acc-h" onclick="accToggle(this)">
              <b>Voice Bible (Auto-Draft)</b><span>▼</span>
            </div>
            <div class="acc-c">
              <div id="voiceBible" class="panel" style="background:#101010;border-color:#1b1b1b"></div>
              <div class="row" style="margin-top:.6rem">
                <button class="ghost btn-sm" onclick="copyBible()">Copy Voice Bible</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- How to read the data -->
      <div class="panel" style="margin-top:1rem">
        <div class="s-head" style="margin-bottom:.4rem">
          <div class="icon">🧠</div><div class="s-title">Decoding the Signals — Operator Notes</div>
        </div>
        <table>
          <thead><tr><th>Signal</th><th>What it tells you</th><th>How to use it in writing</th></tr></thead>
          <tbody>
            <tr><td>Avg sentence length</td><td>Short = punchy authority. Long = reflective/intellectual.</td><td>Match sentence length to client’s cadence across formats.</td></tr>
            <tr><td>Readability (FK)</td><td>Grade level target. Lower = mass market. Higher = specialist.</td><td>Calibrate jargon density and example complexity.</td></tr>
            <tr><td>Em dashes / Colons</td><td>Clause-heavy logic and controlled pacing.</td><td>Use to sequence arguments and add deliberate beats.</td></tr>
            <tr><td>Questions</td><td>Rhetorical engagement, Socratic tone.</td><td>Lead sections with a question to pull attention.</td></tr>
            <tr><td>Proof markers</td><td>Numbers, revenue, screenshots = trust.</td><td>Embed 1–2 concrete receipts in every authority post.</td></tr>
            <tr><td>Distinctive phrases</td><td>Voice fingerprints.</td><td>Place in openers, pivots, and final lines — not every line.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- PHASE 2: INTERNALIZATION -->
    <section class="section" id="internalize">
      <div class="s-head">
        <div class="icon">2</div>
        <div class="s-title">Phase 2 — Internalization: Embody the Voice</div>
      </div>

      <div class="grid grid-2">
        <!-- Tone Translation Exercise -->
        <div class="panel">
          <b>Exercise — Tone Translation</b>
          <p class="muted" style="margin:.4rem 0 .8rem">Rewrite the paragraph in the client’s tone. The scorer checks cadence, punctuation patterns, and emotion/proof signals.</p>
          <label>Source Paragraph</label>
          <textarea id="srcPara" rows="6" placeholder="Paste any neutral paragraph to convert into the client’s voice..."></textarea>
          <label style="margin-top:.6rem">Your Rewrite (Client’s Voice)</label>
          <textarea id="rewritePara" rows="6" placeholder="Write as the client — not about them."></textarea>
          <div class="row" style="margin-top:.7rem">
            <button class="cta btn-sm" onclick="scoreRewrite()">Score Tone Match</button>
            <button class="ghost btn-sm" onclick="swapExample()">Insert Example</button>
          </div>
          <div id="scoreOut" style="margin-top:.7rem"></div>
        </div>

        <!-- Persona Internalization -->
        <div class="panel">
          <b>Persona Internalization — Actor’s Method</b>
          <div class="accordion" style="margin-top:.6rem">
            <div class="acc-h" onclick="accToggle(this)"><span>Watch → Listen → Mimic → Write</span><span>▼</span></div>
            <div class="acc-c">
              <ul style="list-style:none;padding-left:0">
                <li>• Watch 5 minutes of the client speaking (pacing, emphasis, pauses).</li>
                <li>• Read 3 long-form pieces out loud (feel the breath units).</li>
                <li>• Free-write 10 lines in their voice about a random object.</li>
                <li>• Rewrite your last LinkedIn post in their cadence.</li>
              </ul>
            </div>
            <div class="acc-h" onclick="accToggle(this)"><span>Persona Prompts (Reflection)</span><span>▼</span></div>
            <div class="acc-c">
              <ul style="list-style:none;padding-left:0">
                <li>• What emotion drives this client’s decisions?</li>
                <li>• How do they disagree — direct, playful, or precise?</li>
                <li>• Which words never appear in their writing?</li>
                <li>• What do they do instead of using hype?</li>
              </ul>
            </div>
            <div class="acc-h" onclick="accToggle(this)"><span>Quick Quiz — Which line fits?</span><span>▼</span></div>
            <div class="acc-c">
              <div id="quizBox"></div>
              <div class="row" style="margin-top:.6rem">
                <button class="ghost btn-sm" onclick="newQuiz()">New Quiz</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Voice Bible Editor (Human-Readable) -->
      <div class="panel" style="margin-top:1rem">
        <b>Voice Bible — Editor</b>
        <p class="muted" style="margin:.35rem 0 .7rem">This is the human-readable system your team will use — no code, no JSON. Edit and finalize.</p>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:1rem">
          <div>
            <label>Voice Summary</label>
            <textarea id="vb_summary" rows="4"></textarea>
            <label style="margin-top:.5rem">Tone Pillars (3–5)</label>
            <textarea id="vb_tone" rows="3"></textarea>
            <label style="margin-top:.5rem">Emotional Core</label>
            <textarea id="vb_emotion" rows="3"></textarea>
            <label style="margin-top:.5rem">Personality Traits</label>
            <textarea id="vb_persona" rows="3"></textarea>
          </div>
          <div>
            <label>Stylistic Techniques</label>
            <textarea id="vb_style" rows="3"></textarea>
            <label style="margin-top:.5rem">Quirks & Expressions</label>
            <textarea id="vb_quirks" rows="3"></textarea>
            <label style="margin-top:.5rem">Grammar & Punctuation Rules</label>
            <textarea id="vb_grammar" rows="3"></textarea>
            <label style="margin-top:.5rem">Distinctive Phrases</label>
            <textarea id="vb_phrases" rows="3"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:.7rem">
          <button class="cta btn-sm" onclick="fillFromAnalyzer()">Auto-Fill from Analyzer</button>
          <button class="ghost btn-sm" onclick="copyFinalBible()">Copy Final Voice Bible</button>
        </div>
      </div>
    </section>

    <!-- PHASE 3: IMPLEMENTATION -->
    <section class="section" id="implementation">
      <div class="s-head">
        <div class="icon">3</div>
        <div class="s-title">Phase 3 — Implementation: Write With The Voice</div>
      </div>

      <div class="grid grid-2">
        <!-- Format Lab -->
        <div class="panel">
          <b>Format Lab — Guided Writer</b>
          <p class="muted" style="margin:.35rem 0 .7rem">Select a format. The helper injects cadence, tone, and proof cues from the analyzer.</p>
          <div class="row">
            <button class="ghost btn-sm" onclick="loadFormat('thread')">X Thread</button>
            <button class="ghost btn-sm" onclick="loadFormat('linkedin')">LinkedIn Post</button>
            <button class="ghost btn-sm" onclick="loadFormat('newsletter')">Newsletter Section</button>
          </div>
          <div id="formatBox" class="panel" style="background:#101010;border-color:#1b1b1b;margin-top:.7rem"></div>
          <div class="row" style="margin-top:.6rem">
            <button class="cta btn-sm" onclick="toneAssist()">Apply Tone Assist</button>
            <button class="ghost btn-sm" onclick="copyFormat()">Copy Draft</button>
          </div>
        </div>

        <!-- Validation & Iteration -->
        <div class="panel">
          <b>Validation & Iteration — 3-Week Protocol</b>
          <div class="accordion" style="margin-top:.6rem">
            <div class="acc-h" onclick="accToggle(this)"><span>Week 1 — Publish & Collect</span><span>▼</span></div>
            <div class="acc-c">
              <ul style="list-style:none;padding-left:0">
                <li>• Publish 3 posts (1 authority, 1 story, 1 actionable).</li>
                <li>• Gather comments: where readers pause, ask, disagree.</li>
                <li>• Track cadence match: read aloud vs client’s spoken rhythm.</li>
              </ul>
            </div>
            <div class="acc-h" onclick="accToggle(this)"><span>Week 2 — Adjust & Align</span><span>▼</span></div>
            <div class="acc-c">
              <ul style="list-style:none;padding-left:0">
                <li>• Tweak sentence length ±3 words toward target.</li>
                <li>• Insert 1–2 proof markers per authority post.</li>
                <li>• Swap one cliché for a distinctive phrase.</li>
              </ul>
            </div>
            <div class="acc-h" onclick="accToggle(this)"><span>Week 3 — Systemize & Lock</span><span>▼</span></div>
            <div class="acc-c">
              <ul style="list-style:none;padding-left:0">
                <li>• Update Voice Bible (v1.2 → v2.0) with final rules.</li>
                <li>• Create 5 reusable blocks: opener, pivot, CTA, caveat, closer.</li>
                <li>• Share with team; enforce via pre-publish checklist.</li>
              </ul>
            </div>
          </div>

          <div class="panel" style="background:#101010;border-color:#1b1b1b;margin-top:.7rem">
            <b>Version Control</b>
            <table>
              <thead><tr><th>Version</th><th>Date</th><th>Notes</th></tr></thead>
              <tbody id="vcTable">
                <tr><td>v1.0</td><td id="vdate">Nov 1, 2025</td><td>Initial capture from Deterministic Analyzer™</td></tr>
              </tbody>
            </table>
            <div class="row">
              <button class="ghost btn-sm" onclick="addVersion()">Add Version Row</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Final Checklist -->
      <div class="panel" style="margin-top:1rem">
        <b>Final Checklist</b>
        <table>
          <tbody>
            <tr><td>✅ Gather & organize all client materials</td></tr>
            <tr><td>✅ Run Deterministic Analyzer™ and decode signals</td></tr>
            <tr><td>✅ Build Voice Bible and complete tone drills</td></tr>
            <tr><td>✅ Draft across formats with Tone Assist</td></tr>
            <tr><td>✅ Validate in market and iterate to v2.0</td></tr>
          </tbody>
        </table>
      </div>

      <div class="final" style="margin-top:1rem">
        <h2 style="font-size:2rem;margin-bottom:.6rem">Lock the Voice. Lead the Market.</h2>
        <div class="quote">“Voice is the interface to trust. Get the cadence and proof right, and the market hears the founder speaking.”</div>
        <div class="brandline">Built for Ghostwriters. By Ghostwriters.™ • Creating Tomorrow’s Creators is in Our DNA.™</div>
      </div>
    </section>
  </main>

<script>
/* ========= Scroll & Reveal ========= */
const pbar=document.getElementById('pbar');
window.addEventListener('scroll',()=>{
  const t=window.scrollY;
  const h=document.documentElement.scrollHeight-window.innerHeight;
  pbar.style.width=((t/h)*100)+'%';
  document.querySelectorAll('.section').forEach(s=>{
    const r=s.getBoundingClientRect();
    if(r.top<window.innerHeight*0.82){s.classList.add('visible')}
  })
});
function scrollToId(id){document.getElementById(id).scrollIntoView({behavior:'smooth'})}
function accToggle(h){h.nextElementSibling.classList.toggle('open')}

/* ========= Deterministic Analyzer (No API) ========= */
const STOP=new Set(("a,an,the,of,for,to,in,on,at,by,with,from,as,that,this,those,these,be,been,being,am,is,are,was,were,do,does,did,doing,have,has,had,having,not,no,so,if,then,than,and,or,but,into,about,over,under,after,before,between,across,per,each,any,all,most,some,more,less,can,could,should,would,will,just,like,also,you,your,we,our,they,their,them,he,she,it,his,her,its,i,me,my,us").replace(/\s+/g,"").split(","));
function sentences(t){return t.replace(/\s+/g," ").match(/[^.!?]+[.!?…]?/g)||[]}
function words(t){return t.toLowerCase().replace(/[^a-z0-9\s’'-]/g," ").split(/\s+/).filter(Boolean)}
function cleanWord(w){return w.replace(/^[-'’]+|[-'’]+$/g,"")}
function isStop(w){return STOP.has(w)}
function freq(arr){const m=new Map();for(const x of arr){m.set(x,(m.get(x)||0)+1)}return m}
function ngrams(tokens,n){const o=[];for(let i=0;i<=tokens.length-n;i++){const g=tokens.slice(i,i+n);if(g.every(t=>!isStop(cleanWord(t))))o.push(g.join(" "));}return o}
function charCount(t,ch){return (t.match(new RegExp(ch,"g"))||[]).length}
function pct(a,b){return b?Math.round((a/b)*100):0}
function avg(a){return a.length?a.reduce((s,x)=>s+x,0)/a.length:0}
function stdev(a){const m=avg(a);return a.length?Math.sqrt(avg(a.map(x=>(x-m)**2))):0}
function fkGrade(text){
  const sents=sentences(text); const toks=words(text);
  const syll=toks.map(syllables).reduce((a,b)=>a+b,0);
  const W=toks.length||1,S=sents.length||1;const ASL=W/S, ASW=syll/W;
  const grade=0.39*ASL+11.8*ASW-15.59;return Math.max(0,Math.round(grade*10)/10);
}
function syllables(w){w=w.toLowerCase().replace(/[^a-z]/g,"");if(!w)return 0;if(w.length<=3)return 1;return (w.match(/[aeiouy]+/g)||[]).length - (/(e|es|ed)$/.test(w)?1:0) || 1}

const EMOTION={
  hope:new Set(["future","build","momentum","progress","optimism","opportunity","can","will","path","learn","grow","scale","ship"]),
  fear:new Set(["risk","danger","fail","mistake","loss","downside","warning","threat","crash","burn","fear","panic"]),
  envy:new Set(["rich","million","billion","status","exclusive","private","insider","access","elite","rare"]),
  urgency:new Set(["now","today","tonight","deadline","last","final","close","hurry","immediately"]),
  proof:new Set(["proof","screenshot","receipts","evidence","case","test","metric","data"])
};
const CREDS=[/[\$£€]\s?\d+([,.\d]*)?/g,/\b\d{1,3}(?:,\d{3})+(?:\.\d+)?\b/g,/\b\d+%/gi,/\b(leads?|sales?|revenue|impressions|subscribers?)\b/gi];
const STYLE={analogy:/\b(like|as if|as though)\b/i,list:/\b(1\.|2\.|3\.|\*|-)\s/i,story:/\b(then|later|after|because|so|finally)\b/i}

const el={
  samples:document.getElementById('samples'),
  clientName:document.getElementById('clientName'),
  analyzeBtn:document.getElementById('analyzeBtn'),
  clearBtn:document.getElementById('clearBtn'),
  taboos:document.getElementById('taboos'),
  required:document.getElementById('required'),
  snapshot:document.getElementById('snapshot'),
  mSent:document.getElementById('m_sent'),
  avgSent:document.getElementById('avgSent'),
  stdSent:document.getElementById('stdSent'),
  avgPar:document.getElementById('avgPar'),
  fk:document.getElementById('fk'),
  qs:document.getElementById('qs'),
  ex:document.getElementById('ex'),
  emd:document.getElementById('emd'),
  ell:document.getElementById('ell'),
  cs:document.getElementById('cs'),
  phrasesArea:document.getElementById('phrasesArea'),
  bible:document.getElementById('voiceBible')
};

let ANALYSIS=null;

el.clearBtn.onclick=()=>{el.samples.value='';el.snapshot.innerHTML='<p class="muted">Cleared.</p>';resetMeters();el.phrasesArea.innerHTML='';el.bible.innerHTML='';ANALYSIS=null;};

el.analyzeBtn.onclick=()=>{
  const raw=el.samples.value.trim();
  if(raw.length<500){alert('Add more material (≥500 words) for a reliable signal.');return}
  const cname=el.clientName.value.trim()||'[Client]';

  const sents=sentences(raw);
  const toks=words(raw).map(cleanWord).filter(Boolean);
  const nostop=toks.filter(t=>!isStop(t));
  const W=toks.length,S=sents.length;

  const sLens=sents.map(s=>words(s).length);
  const avgS=Math.round(avg(sLens));
  const stdS=Math.round(stdev(sLens));
  const qCount=(raw.match(/\?/g)||[]).length;
  const eCount=(raw.match(/!/g)||[]).length;
  const emdash=charCount(raw,'—')+charCount(raw,'–');
  const ellips=(raw.match(/\.\.\./g)||[]).length;
  const colon=charCount(raw,':'), semi=charCount(raw,';');
  const pars=raw.split(/\n{2,}/).map(p=>words(p).length).filter(x=>x>0);
  const avgP=Math.round(avg(pars))||0;

  const grade=fkGrade(raw);
  let credHits=0;CREDS.forEach(rx=>{const m=raw.match(rx);if(m)credHits+=m.length});

  const emo={};for(const [k,set] of Object.entries(EMOTION)){emo[k]=toks.filter(t=>set.has(t)).length}

  const uni=freq(nostop), bi=freq(ngrams(toks,2)), tri=freq(ngrams(toks,3)), quad=freq(ngrams(toks,4));
  const topTri=[...tri.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
  const topQuad=[...quad.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10).map(x=>x[0]);
  const phrases=[...topTri,...topQuad].slice(0,14);

  const tone=[];
  if(avgS<=18 && stdS<=8) tone.push('Concise');
  if(emdash>0||colon>0) tone.push('Structured');
  if(credHits>2) tone.push('Credibility-forward');
  if(emo.urgency>2) tone.push('Urgent');
  if(emo.hope>emo.fear) tone.push('Optimistic');
  if(emo.fear>emo.hope) tone.push('Risk-aware');
  if(tone.length===0) tone.push('Neutral-assertive');

  ANALYSIS={cname,avgS,stdS,avgP,grade,qCount:eCount? qCount:qCount, eCount, emdash, ellips, colonSemi:colon+semi, emo, credHits, tone, phrases, tokens:W, sentences:S, uni:[...uni.entries()].sort((a,b)=>b[1]-a[1]).slice(0,14)};

  // Snapshot
  el.snapshot.innerHTML=`
    <div><b>${esc(cname)}</b></div>
    <div class="muted" style="margin:.25rem 0 .5rem">Summary:</div>
    <div>${esc(summarizeTone(tone,avgS,grade,credHits))}</div>
    <div style="margin-top:.5rem">${tone.map(t=>`<span class="pill">${esc(t)}</span>`).join('')}</div>
    <div class="muted" style="margin-top:.5rem">Emotion cues → ${Object.entries(emo).map(([k,v])=>`${k}:${v}`).join(' • ')}</div>
    <div style="margin-top:.8rem">
      <div>Voice Strength</div>
      <div class="meter"><div id="m_strength" style="width:0"></div></div>
    </div>
  `;
  setTimeout(()=>{
    const strength=Math.max(20,Math.min(100, 20 + (tone.includes('Credibility-forward')?20:0) + (emo.hope+emo.proof>3?20:0) + (phrases.length>6?20:0)));
    const ms=document.getElementById('m_strength'); if(ms) ms.style.width=strength+'%';
  },50);

  // Meters & stats
  el.avgSent.textContent=avgS; el.stdSent.textContent=stdS; el.avgPar.textContent=avgP; el.fk.textContent=grade;
  el.qs.textContent=ANALYSIS.qCount; el.ex.textContent=eCount; el.emd.textContent=emdash; el.ell.textContent=ellips; el.cs.textContent=colon+semi;
  el.mSent.style.width=Math.min(100,(avgS/30)*100)+'%';

  // Phrases
  el.phrasesArea.innerHTML = phrases.length? phrases.map(p=>`<span class="pill">${esc(p)}</span>`).join(''):'<span class="muted">No strong phrases surfaced yet.</span>';

  // Voice Bible Auto-draft
  el.bible.innerHTML = makeBibleHTML(ANALYSIS);
};

function resetMeters(){['m_sent'].forEach(id=>{const el=document.getElementById(id); if(el) el.style.width='0'})}
function esc(s){return (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function summarizeTone(tone,avgS,grade,cred){const t=tone.slice(0,3).join(', ');const cad=avgS<=16?'short-form':'balanced';const rd=grade<=7?'accessible':grade<=12?'professional':'specialist';const cr=cred>2?'driven by receipts':'light on numbers';return `Voice presents as ${t}, with ${cad} cadence and ${rd} readability; ${cr}.`}

function makeBibleHTML(a){
  const vocab=a.uni.map(([w,c])=>w).slice(0,10).join(', ');
  return `
    <div><b>Voice Summary</b><br>${esc(summarizeTone(a.tone,a.avgS,a.grade,a.credHits))}</div><br>
    <div><b>Tone Pillars</b><br>${a.tone.map(t=>`<span class="pill">${esc(t)}</span>`).join('')}</div><br>
    <div><b>Emotional Core</b><br>${Object.entries(a.emo).sort((x,y)=>y[1]-x[1]).map(([k,v])=>`${esc(k)}: ${v}`).join(' • ')}</div><br>
    <div><b>Personality Traits</b><br>${inferPersona(a).map(t=>`<span class="pill">${esc(t)}</span>`).join('')}</div><br>
    <div><b>Stylistic Techniques</b><br>
      ${a.emdash>0||a.colonSemi>0? '• Clause-driven logic (em dashes/colons)<br>':''}
      ${a.qCount>0? '• Rhetorical questioning<br>':''}
      ${a.ellips>0? '• Ellipses for soft pacing<br>':''}
      • Proof integration: ${a.credHits>2? 'High':'Low'}
    </div><br>
    <div><b>Quirks & Expressions</b><br>
      ${a.emdash>0? '— Em dashes as beat control<br>':''}
      ${a.colonSemi>0? '— Uses colons/semicolons to stage logic<br>':''}
      ${a.qCount>0? '— Question-led transition lines<br>':''}
    </div><br>
    <div><b>Grammar & Punctuation</b><br>
      Avg sentence: <b>${a.avgS}</b> • Variability: <b>${a.stdS}</b> • Avg paragraph: <b>${a.avgP}</b> • FK: <b>${a.grade}</b>
    </div><br>
    <div><b>Distinctive Phrases (use sparingly)</b><br>${a.phrases.map(p=>`<span class="pill">${esc(p)}</span>`).join('')}</div><br>
    <div><b>Vocabulary Tendencies</b><br>${esc(vocab)}</div>
  `;
}
function inferPersona(a){
  const out=new Set();
  if(a.tone.includes('Concise')) out.add('Direct');
  if(a.tone.includes('Credibility-forward')) out.add('Evidence-based');
  if(a.tone.includes('Optimistic')) out.add('Ambitious');
  if(a.tone.includes('Risk-aware')) out.add('Pragmatic');
  if(a.emo.urgency>2) out.add('Decisive');
  if(out.size===0) out.add('Measured');
  return [...out];
}
function copyBible(){
  const tmp=document.createElement('textarea');
  tmp.value=document.getElementById('voiceBible').innerText;
  document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp);
  alert('Voice Bible copied.');
}

/* ========= Tone Translation Scorer ========= */
function scoreRewrite(){
  if(!ANALYSIS){alert('Run the analyzer first.');return}
  const src=document.getElementById('srcPara').value.trim();
  const rw=document.getElementById('rewritePara').value.trim();
  if(!src||!rw){alert('Add both source and rewrite.');return}

  const s1=sentences(rw).map(s=>words(s).length); const avgRw=avg(s1)||0;
  const emRw=charCount(rw,'—')+charCount(rw,'–'); const qRw=(rw.match(/\?/g)||[]).length; const exRw=(rw.match(/!/g)||[]).length;
  const emos={}; for(const [k,set] of Object.entries(EMOTION)){emos[k]=words(rw).filter(t=>set.has(t)).length}
  const proof = CREDS.reduce((n,rx)=>n+((rw.match(rx)||[]).length),0);

  // Scores: cadence (40), punctuation pattern (20), emotion/intent (20), proof integration (20)
  let cadenceScore = 40 - Math.min(40, Math.abs(avgRw - ANALYSIS.avgS)*2.5);
  let punctScore = 0;
  punctScore += (Math.min(ANALYSIS.qCount,1)===Math.min(qRw,1))?8:0;
  punctScore += (Math.min(ANALYSIS.eCount,1)===Math.min(exRw,1))?4:0;
  punctScore += (ANALYSIS.emdash>0 && emRw>0)?8: (ANALYSIS.emdash===0 && emRw===0?8:0);

  let intentScore = 0;
  const topE = Object.entries(ANALYSIS.emo).sort((a,b)=>b[1]-a[1])[0]?.[0]||'hope';
  intentScore = Math.min(20, (emos[topE]||0)*4);

  let proofScore = Math.min(20, proof*6);

  const total = Math.max(0, Math.round(cadenceScore + punctScore + intentScore + proofScore));
  const verdict = total>=85? 'Elite match' : total>=70? 'Strong match' : total>=55? 'Workable' : 'Off-voice';

  document.getElementById('scoreOut').innerHTML = `
    <div class="panel" style="background:#101010;border-color:#1b1b1b">
      <div><b>Tone Match:</b> <span class="${total>=70?'ok':total>=55?'warn':'bad'}">${total}/100</span> — ${verdict}</div>
      <div class="grid" style="grid-template-columns:1fr 1fr;margin-top:.5rem">
        <div>
          <div>Target avg sentence: <b>${ANALYSIS.avgS}</b></div>
          <div>Your avg sentence: <b>${Math.round(avgRw)}</b></div>
        </div>
        <div>
          <div>Questions/Exclamations/Em dashes: <b>${ANALYSIS.qCount}/${ANALYSIS.eCount}/${ANALYSIS.emdash}</b></div>
          <div>Yours: <b>${qRw}/${exRw}/${emRw}</b></div>
        </div>
      </div>
    </div>
  `;
}
function swapExample(){
  document.getElementById('srcPara').value="Our product helps small teams move faster by automating repetitive tasks. Most founders waste hours every week doing manual updates. We built a workflow that saves time and reduces mistakes.";
  document.getElementById('rewritePara').value="";
}

/* ========= Quick Quiz ========= */
const quizSamples=[
  {prompt:'Client favors clause-heavy, proof-led tone.', options:[
    'We got results. It worked. Next.', 
    'Here’s the sequence: hypothesis — test — receipts — decision.', 
    'Nice work team!! So proud!!'], correct:1},
  {prompt:'Client avoids hype, uses measured authority.', options:[
    'This is insane — you’ve never seen anything like it!!!',
    'Net-net: the model holds at 12% lift on paid + 7% organic.',
    'OMG this blew my mind today!'], correct:1},
  {prompt:'Client uses question-led transitions.', options:[
    'Consider the alternative: what breaks when volume triples?',
    'Best thing ever made.', 
    'Buy now or miss out.'], correct:0}
];
function newQuiz(){
  const q=quizSamples[Math.floor(Math.random()*quizSamples.length)];
  const box=document.getElementById('quizBox');
  box.innerHTML=`<div style="margin-bottom:.5rem"><b>${esc(q.prompt)}</b></div>`+
    q.options.map((o,i)=>`<button class="ghost btn-sm" onclick="answerQuiz(${q.correct},${i},this)">${esc(o)}</button>`).join(' ');
}
function answerQuiz(correct,i,btn){
  const parent=btn.parentElement; [...parent.querySelectorAll('button')].forEach((b,idx)=>{
    b.style.borderColor= idx===correct? '#00ffa0':'#ff5c5c'; b.style.color= idx===correct? '#00ffa0':'#ff5c5c';
  });
}
newQuiz();

/* ========= Voice Bible Editor Helpers ========= */
function fillFromAnalyzer(){
  if(!ANALYSIS){alert('Run the analyzer first.');return}
  document.getElementById('vb_summary').value = summarizeTone(ANALYSIS.tone,ANALYSIS.avgS,ANALYSIS.grade,ANALYSIS.credHits);
  document.getElementById('vb_tone').value = ANALYSIS.tone.join(', ');
  document.getElementById('vb_emotion').value = Object.entries(ANALYSIS.emo).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}:${v}`).join(', ');
  document.getElementById('vb_persona').value = inferPersona(ANALYSIS).join(', ');
  document.getElementById('vb_style').value = `${ANALYSIS.emdash>0?'Em dashes for pacing; ':''}${ANALYSIS.colonSemi>0?'Colons/Semis for logic; ':''}${ANALYSIS.qCount>0?'Question-led transitions; ':''}Proof: ${ANALYSIS.credHits>2?'High':'Low'}`;
  document.getElementById('vb_quirks').value = `${ANALYSIS.emdash>0?'— beats; ':''}${ANALYSIS.qCount>0?'Q-led pivots; ':''}${ANALYSIS.ellips>0?'Ellipses; ':''}`.replace(/\s+$/,'');
  document.getElementById('vb_grammar').value = `Avg sentence ${ANALYSIS.avgS} (±${ANALYSIS.stdS}); FK ${ANALYSIS.grade}; Avoid fluff; Prefer active voice.`;
  document.getElementById('vb_phrases').value = ANALYSIS.phrases.join(' | ');
}
function copyFinalBible(){
  const fields=['vb_summary','vb_tone','vb_emotion','vb_persona','vb_style','vb_quirks','vb_grammar','vb_phrases'].map(id=>({id,el:document.getElementById(id)}));
  const out = `VOICE SUMMARY:\n${fields[0].el.value}\n\nTONE PILLARS:\n${fields[1].el.value}\n\nEMOTIONAL CORE:\n${fields[2].el.value}\n\nPERSONALITY TRAITS:\n${fields[3].el.value}\n\nSTYLISTIC TECHNIQUES:\n${fields[4].el.value}\n\nQUIRKS & EXPRESSIONS:\n${fields[5].el.value}\n\nGRAMMAR & PUNCTUATION:\n${fields[6].el.value}\n\nDISTINCTIVE PHRASES:\n${fields[7].el.value}`;
  const tmp=document.createElement('textarea'); tmp.value=out; document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp);
  alert('Final Voice Bible copied.');
}

/* ========= Format Lab ========= */
let CURRENT_FORMAT='thread';
function loadFormat(type){
  CURRENT_FORMAT=type;
  if(!ANALYSIS){
    document.getElementById('formatBox').innerHTML='<p class="muted">Run the analyzer first to enable Tone Assist. You can still draft below.</p>'+formatTemplate(type,'');
    return;
  }
  document.getElementById('formatBox').innerHTML = formatTemplate(type, ANALYSIS);
}
function formatTemplate(type, A){
  const baseNotes = A? `
  <div class="callout" style="margin-bottom:.6rem">
    <b>Tone Assist:</b> target avg sentence <b>${A.avgS}</b>; ${A.tone.includes('Credibility-forward')?'embed receipts; ':''}${A.emdash>0?'use em dashes for beats; ':''}top emotion: <b>${Object.entries(A.emo).sort((a,b)=>b[1]-a[1])[0]?.[0]||'hope'}</b>.
  </div>` : '';
  if(type==='thread'){
    return `${baseNotes}
      <label>Thread Draft</label>
      <textarea id="draftBox" rows="10" placeholder="1) Hook\n2) Setup\n3) Lesson\n4) Proof\n5) CTA"></textarea>`;
  }else if(type==='linkedin'){
    return `${baseNotes}
      <label>LinkedIn Draft</label>
      <textarea id="draftBox" rows="10" placeholder="• Relatable opener\n• Insight with example\n• Mini-proof\n• Clear takeaway\n• CTA"></textarea>`;
  }else{
    return `${baseNotes}
      <label>Newsletter Section</label>
      <textarea id="draftBox" rows="10" placeholder="Subject idea\n— Lead story (voice-true)\n— Lesson with numbers\n— Actionable close + CTA"></textarea>`;
  }
}
function toneAssist(){
  if(!ANALYSIS){alert('Run the analyzer first.');return}
  const box=document.getElementById('draftBox'); if(!box){alert('Load a format first.');return}
  const text=box.value;
  if(!text.trim()){alert('Write a quick draft first.');return}
  // Light-touch adjustments: sentence target & proof hint
  const target=ANALYSIS.avgS;
  const lines=text.split('\n').map(l=>{
    const len=words(l).length;
    if(len>target+6){return l.replace(/, /g,' — ').replace(/ and /gi,' • ').replace(/\s{2,}/g,' ').trim()}
    if(len<Math.max(8,target-6)){return l + (ANALYSIS.emdash>0?' —':'') + ' ' + (ANALYSIS.phrases[0]||'Here’s the move:')}
    return l;
  });
  // Append a proof nudge if credibility-forward
  if(ANALYSIS.credHits>2 && !/(\$|\d+%|\d{1,3}(?:,\d{3})+)/.test(text)){
    lines.push('Proof: add one concrete metric or receipt here.');
  }
  box.value=lines.join('\n');
}
function copyFormat(){
  const box=document.getElementById('draftBox'); if(!box){alert('Nothing to copy.');return}
  const tmp=document.createElement('textarea'); tmp.value=box.value; document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp);
  alert('Draft copied.');
}

/* ========= Version Control ========= */
function addVersion(){
  const tb=document.getElementById('vcTable');
  const d=new Date();
  const line=`<tr><td>v${(Math.random()*1.5+1.2).toFixed(1)}</td><td>${d.toLocaleDateString()}</td><td>Refined tone pillars, cadence target, and proof cadence.</td></tr>`;
  tb.insertAdjacentHTML('beforeend',line);
}
</script>
</body>
</html>
